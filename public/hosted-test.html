<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmileID Hosted Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .btn { padding: 12px 24px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #22c55e; color: white; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        #smile-frame { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SmileID Hosted Integration Test</h1>
        <p>This uses SmileID's hosted solution - more reliable than the JavaScript SDK</p>
        
        <div>
            <input type="text" id="userId" placeholder="User ID" value="hosted-test-001" style="padding: 10px; margin: 10px; width: 200px;">
            <select id="product" style="padding: 10px; margin: 10px;">
                <option value="smartselfie">SmartSelfie</option>
                <option value="biometric_kyc">Biometric KYC</option>
                <option value="enhanced_kyc">Enhanced KYC</option>
            </select>
            <button class="btn btn-primary" onclick="startHostedIntegration()">Start Verification</button>
        </div>
        
        <div id="status"></div>
        <iframe id="smile-frame" src="about:blank" style="display: none;"></iframe>
        
        <div style="margin-top: 20px;">
            <h3>Instructions:</h3>
            <ol>
                <li>Click "Start Verification" above</li>
                <li>Complete the verification in the iframe</li>
                <li>Results will appear in the status area</li>
            </ol>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let currentUserId = null;

        async function startHostedIntegration() {
            const userId = document.getElementById('userId').value || 'hosted-test-001';
            const product = document.getElementById('product').value;
            
            updateStatus('Generating token...', 'info');
            
            try {
                // Generate token
                const response = await fetch('/api/token/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, product })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentJobId = data.jobId;
                    currentUserId = data.userId;
                    
                    updateStatus('Token generated! Loading SmileID interface...', 'success');
                    
                    // Create hosted URL
                    const hostedUrl = createHostedUrl(data.token, data.partnerId);
                    
                    // Show iframe
                    const iframe = document.getElementById('smile-frame');
                    iframe.src = hostedUrl;
                    iframe.style.display = 'block';
                    
                    // Start checking status
                    setTimeout(() => checkJobStatus(), 5000);
                    
                } else {
                    updateStatus('Token generation failed: ' + data.message, 'error');
                }
                
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }
        
        function createHostedUrl(token, partnerId) {
            // This would be SmileID's hosted URL with your token
            // For testing, we'll create a mock URL
            return `data:text/html,
                <html>
                    <body style="font-family: Arial; text-align: center; padding: 50px;">
                        <h2>üé≠ SmileID Hosted Integration</h2>
                        <p>Token: ${token.substring(0, 20)}...</p>
                        <p>Partner ID: ${partnerId}</p>
                        <div style="margin: 30px;">
                            <button onclick="parent.completeVerification()" style="background: #22c55e; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                                ‚úÖ Complete Verification (Simulated)
                            </button>
                        </div>
                        <p><small>In production, this would be SmileID's actual hosted interface</small></p>
                    </body>
                </html>
            `;
        }
        
        window.completeVerification = function() {
            updateStatus('Verification completed! Processing results...', 'success');
            
            // Submit job
            fetch('/api/status/submit-job', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUserId,
                    jobId: currentJobId,
                    jobType: document.getElementById('product').value,
                    images: { selfie: 'hosted-integration-data' }
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    updateStatus('‚úÖ Job submitted successfully! Verification complete.', 'success');
                } else {
                    updateStatus('‚ùå Job submission failed: ' + data.message, 'error');
                }
            })
            .catch(err => {
                updateStatus('‚ùå Submission error: ' + err.message, 'error');
            });
            
            // Hide iframe
            document.getElementById('smile-frame').style.display = 'none';
        };
        
        async function checkJobStatus() {
            if (!currentUserId || !currentJobId) return;
            
            try {
                const response = await fetch(`/api/status/${currentUserId}/${currentJobId}`);
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('Job status: ' + JSON.stringify(data.status, null, 2), 'info');
                } else {
                    updateStatus('Status check: ' + data.message, 'info');
                }
            } catch (error) {
                console.log('Status check error:', error);
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            console.log(message);
        }
    </script>
</body>
</html>